---
title: "TEOS HydroStation S Data Lab"
author: "Irais Luquis Ramos"
date: "2023-03-07"
output:
  prettydoc::html_pretty:
    theme: cayman
    highlight: github
---

#Load required libraries

```{r message=FALSE}
library(tidyverse)
library(gsw)
library(ggplot2)
library(plotly)
#install.packages('seacarb')
#install.packages('prettydoc')
```

#Now we need to import our data

```{r warning=FALSE, message=FALSE}
library(readr)
hydrostation_bottle <- read_table("hydrostation_bottle.txt", 
    col_names = FALSE, skip = 31)

library(readr)
hydrostation_bottle_names <- read_csv("hydrostation_bottle.txt", 
    skip = 30)



colnames(hydrostation_bottle)=colnames(hydrostation_bottle_names)
view(hydrostation_bottle)
```

Variable Names and Units

-   yyyymmdd = Year Month Day\
-   decy = Decimal Year\
-   time = Time (hhmm)\
-   latN = Latitude (Deg N)
-   lonW = Longitude (Deg W)
-   Depth = Depth (m)\
-   Temp = Temperature ITS-90 (C)
-   Pres = CTD Pressure (dbar)\
-   CTD_S = CTD Salinity (PSS-78)\
-   Sal1 = Salinity-1 (PSS-78)\
-   Sig-th = Sigma-Theta (kg/m\^3)\
-   O2(1) = Oxygen-1 (umol/kg)\
-   OxFixT = Oxygen Fix Temp (C)\
-   Anom1 = Oxy Anomaly-1 (umol/kg)\
    Quality flags
-   -999 = No data
-   0 = Less than detection limit

```{r}
#lets firts plot the data
hydrostation_bottle %>%
  ggplot()+
  geom_point(aes(x = decy, y = `Sig-th`))


hydrostation_bottle %>%
  filter(`Sig-th`!=-999) %>%
  ggplot()+
  geom_point(aes(x = decy, y = `Sig-th`))

hydrostation_bottle %>%
  filter(`Sig-th`!=-999 & Depth <20) %>%
  ggplot()+
  geom_point(aes(x = decy, y = `Sig-th`))

hydrostation_bottle %>%
  filter(`Sig-th`!=-999 & Depth <20) %>%
  ggplot()+
  geom_line(aes(x = decy, y = `Sig-th`))

#clear seasonal signal for sigma-theta,lets see how this compares to temperature
hydrostation_bottle %>%
  filter(`Sig-th`!=-999 & Depth <20) %>%
  ggplot()+
  geom_point(aes(x = Temp, y = `Sig-th`))
#Temperatures and density ares strongly correleted, but there appears to be two outliers tht we sill likley need to adreess at some point
#we only have density data from 1988-present, but temperature and salinity data from 1950s-present 
#This means I can calculate seawater density from 1950s-present 
#we can use the TEOS-10 to do this



```
## TEOS-10 Toolbox in Package seacarb

```{r}
?gsw #launches the documentation for the gibbs seawater toolbox (TEOS-10). All of this function within the package 

?gsw_sigma0 #lets check this function 
#it says we need absolute salinity and conservative temperature USAGE


#first we need absolute salinity:
?gsw_SA_from_SP
#practical salinity
#sea pressure (dbar)
#longitude 
#latitude

#Lets plot our pressure data - its missing before 1980s
hydrostation_bottle %>%
  ggplot()+
  geom_point(aes(x=decy, y=Pres))

#we have depth data for the time series 
hydrostation_bottle %>%
  ggplot()+
  geom_point(aes(x=decy, y=Depth))

?gsw_p_from_z

#adds a pressure colum from the depth and latN colums from/to hydrostation bottle #creates new variable

hydrostation_bottle=
hydrostation_bottle %>%
  mutate(Pres_gsw=gsw_p_from_z(Depth*-1,latN))

hydrostation_bottle %>%
  ggplot()+
  geom_point(aes(x=Pres, y=Pres_gsw))
#we see strong 1:1 agreement between measured pressure and calculated pressure

hydrostation_bottle %>%
  ggplot()+
  geom_point(aes(x=decy, y=latN))

hydrostation_bottle %>%
  ggplot()+
  geom_point(aes(x=decy, y=lonW))

hydrostation_bottle %>%
  ggplot()+
  geom_point(aes(x=decy, y=CTD_S))

#Checking lat, lon and salinity data
hydrostation_bottle %>%
  ggplot()+
  geom_point(aes(x=decy, y=Sal1))

hydrostation_bottle=
hydrostation_bottle %>%
  mutate(Pres_gsw=gsw_p_from_z(Depth*-1,latN)) %>%
  mutate(S_abs_gsw=gsw_SA_from_SP(Sal1,Pres_gsw,360-lonW,latN))

#chek it 
hydrostation_bottle %>%
  ggplot()+
  geom_point(aes(x=decy, y=S_abs_gsw))
#how else can I check my data
hydrostation_bottle %>%
  filter(Sal1!=-999) %>%
  ggplot()+
  geom_point(aes(x=Sal1, y=S_abs_gsw))

#now we need to calculate conservative temperature
?gws_CT_from_t
#we need absolute salinity, in-situ temp (ITS-90), and sea pressure 

#add line to calculate conservative temperature and change from hydrostation_bottle to HydrosS to not create confusion
HydroS=
hydrostation_bottle %>%
  filter(Sal1!=-999) %>% #filter for salinity missing
  filter(Temp!=-999) %>%
  mutate(Pres_gsw=gsw_p_from_z(Depth*-1,latN)) %>% #pressure for depth
  mutate(S_abs_gsw=gsw_SA_from_SP(Sal1,Pres_gsw,360-lonW,latN)) %>%
  mutate(T_cons_gsw=gsw_CT_from_t(S_abs_gsw,Temp,Pres_gsw))

#missing data por eso se aÃ±adio filter 

#hydrostation_bottle %>%
  #filter(Sal1!=-999) %>%
  #ggplot()+
  #geom_point(aes(x=Sal1, y=S_abs_gsw))

#hydrostation_bottle %>%
  #filter(Temp!=-999) %>%
  #ggplot()+
  #geom_point(aes(x=Temp, y=T_cons_gsw))

HydroS=
hydrostation_bottle %>%
  filter(Sal1!=-999) %>% 
  filter(Temp!=-999) %>%
  mutate(Pres_gsw=gsw_p_from_z(Depth*-1,latN)) %>% 
  mutate(S_abs_gsw=gsw_SA_from_SP(Sal1,Pres_gsw,360-lonW,latN)) %>%
  mutate(T_cons_gsw=gsw_CT_from_t(S_abs_gsw,Temp,Pres_gsw)) %>%
  mutate(sig_th_gsw=gsw_sigma0(S_abs_gsw,T_cons_gsw))
  
HydroS %>%
  filter(`Sig-th` !=-999) %>%
  ggplot()+
  geom_point(aes(x=`Sig-th`,y=sig_th_gsw))
#but we have a very low sig-th-gsw so lets find it 

#our bottle and ctd salonity do not agree, this is likley the problem for the low
HydroS %>%
  filter(sig_th_gsw<0) %>%
  view()

HydroS_correctedS_a=
  HydroS %>% 
  filter(sig_th_gsw<0) %>% #filter for negative value 
  mutate(S_abs_gsw=gsw_SA_from_SP(CTD_S,Pres_gsw,360-lonW,latN)) %>%
  mutate(T_cons_gsw=gsw_CT_from_t(S_abs_gsw,Temp,Pres_gsw)) %>%
  mutate(sig_th_gsw=gsw_sigma0(S_abs_gsw,T_cons_gsw)) 

HydroS_correctedS_b=
  HydroS %>% 
  filter(sig_th_gsw>0) 

HydroS_correctedS = rbind(HydroS_correctedS_a,HydroS_correctedS_b)

HydroS_correctedS %>% 
  filter(`Sig-th`!=-999) %>%
  ggplot()+
  geom_point(aes(x=`Sig-th`,y=sig_th_gsw))

#Homework 

HydroS_correctedS %>% 
  ggplot()+
  geom_point(aes(x=sig_th_gsw,y=Depth))+
  scale_y_reverse()+
  scale_x_continuous(position='top')+
  #xlab(expression(paste(sigma[theta], "(kg m"^"-3",")"))) 
  xlab(expression(paste(sigma*theta, "(kg m"^"-3",")" )))+
  ylab('Depth (m)')+ 
  theme_classic()




  
```


# Has surface sigma theta decreased over time?

```{r}
HydroS_shallow= HydroS_correctedS %>%
  filter(Depth>30)

?lm #constroc a linear model
#lm(y~x, data=data) y is a funcion of x meaning data=data 
lm(sig_th_gsw~decy,data=HydroS_shallow)
#coefficients (intercept and decay)
#y=mx+b
#y=sig_th_gsw
#x=decy
#coefficient: intercept= b, decy=m
#sig_th_gsw= -0.004*decy + 33.4
#(kg/m3) = (kg/m3/y)*y + (kg/m3)

sig_theta_time_model=lm(sig_th_gsw~decy,data=HydroS_shallow)
summary(sig_theta_time_model)


plot=HydroS_shallow %>%
  ggplot(aes(x=decy,y=sig_th_gsw))+
  geom_point()+
  geom_line()+
  geom_smooth(method="lm")+
  theme_classic()

ggplotly(plot)
  
```

#Lab Assignment

1. Pick a question
2. Produce a plot and a statistical summary using lm()
3. Describe your results, the summary, and answer the question 
4. Compile into a completed lab report using R markdown

Potentia question: Include hypothesis (usar pag de cosas que se pueden calcualr)

  How do temperature, salinity, and sigma-theta co-vary?
  Is there a relationship between sigma theta and oxygen?
  Is there a relationship of the parameters with depth? with time?
Whithin a depth range over time?
  Are there seasonal differences in any of the parameters?
  
```{r}
HydroS_seaosons_1=
  HydroS_correctedS %>% 
  mutate(month=as.numeric(substr(yyyymmd,5,6))) %>% 
  mutate(season=ifelse(month==12|month==1|month==2|month==3,'winter', ifelse(month==8|month==9|month==10, 'summer','')))

view(HydroS_seaosons_1)
?substr

#In Bermuda; Dec to March = winter months August-October = Summer Months
#whic mean if month is greater than august (8) and month is less or equal to 10...

#Is disolved oxygen 
#Is salinity higher in summmer than winter?
#Is sound speed higher 
#is spicines higher

summary(lm(`o2(1)`~season,data=HydroS_seaoson_1))

month>=8&month<=10

HydroS_months$season=
  month==c(12,1,2,3)
  
HydroS_months$season=
  with(HydroS_months, ifelse(month==c(12,1,2,3),'winter',
                             ifelse(month==c(8,9,10),'summer','')))



```
?gsw
?gsw_CT_from_rho

#The relationship between conservative temperature and density throught time/seasons? #Many elements 


#The change in density througt seasons 

#Changes over time in conservative temperature. 
  
```{r}
#HydroS_seaoson_2=
  HydroS_correctedS %>% 
  mutate(month=as.numeric(substr(yyyymmd,5,6))) %>% 
  mutate(season=ifelse(month==12|month==12|month==1|month==2,'winter', ifelse(month==6|month==7|month==8, 'summer',
ifelse(month==3|month==4|month==5,'spring',
ifelse(month==9|month==10|month==10,'Autum', '')))))+

#View(HydroS_seaoson_2)

S_D=HydroS_seaoson %>%
  ggplot(aes(x=month,y=decy))+
  geom_point()+
  geom_line()+
  geom_smooth(method="lm")+
  theme_classic()

S_D 

summary(lm(`Sig-th`~month,data=HydroS_seaoson)) 





###################TIME 

HydroS_time=
  HydroS_correctedS %>%
  mutate(hours=as.numeric(substr(time,2,3))) %>% 
  

HydroS_time

summary(lm(`Sig-th`~hours,data=HydroS_time))



```
  
#########Lab Assigment question 

1. Question and hypothesis

-What are the changes in conservative temperature over time? Is conservative temperature higher in summer than winter?

Conservative temperature is increasing over time... and is higher in...
  
2. Produce a plot and a statistical summary using lm()

# The data gives me the Temperature ITS-90 (C) wich is the potential temperature. To get the conservative temperature 
  I need to use;
  CT = gsw_CT_from_pt(SA,pt)
  
#Firts plot the data to see what are we working with and eliminate the missing data
```{r}
hydrostation_bottle %>%
  filter(Temp!=-999) %>%
  ggplot()+
  geom_point(aes(x = decy, y = Temp)) 

#Create variable for x=month y=CT

#clear seasonal signal for Temperature,lets see how this compares to seasons
#Create Variable of month to see how it compares to winter vs. summer 

hydrostation_bottle %>%
  filter(Temp!=-999) %>%
  ggplot()+
  geom_point(aes(x = decy, y = Temp))+
  mutate(month=as.numeric(substr(yyyymmd,5,6))) %>% 
  mutate(month=ifelse(month==12|month==1|month==2|month==3,'winter', ifelse(month==8|month==9|month==10, 'summer','')))



  
```

